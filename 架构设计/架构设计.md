# 架构设计目的

- 架构设计是为了解决软件复杂度带来的问题
    - 通过熟悉和理解需求，识别系统复杂性所在的地方，然后针对这些复杂点进行架构设计。
    - 架构设计并不是要面面俱到，不需要每个架构都具备高性能、高可用、高扩展等特点，而是要识别出复杂点然后有针对性地解决问题。
    - 理解每个架构方案背后所需要解决的复杂点，然后才能对比自己的业务复杂点，参考复杂点相似的方案。

# 架构设计流程

## 1. 需求介绍

+ [需求介绍主要描述需求的背景、目标、范围等]

    - 系统：操盘风控系统，代理后台，运营系统

    - 核心业务：下注 充值 会员 代理

    - 功能模块：

      > 1、登陆子系统 （单点登陆，多子系统支持验证）

        1. 会员中心（会员基本信息、等级、会员画像标签管理）

        2. 代理中心（代理佣金体系）

        3. 报表中心（全部业务报表）

        4. 风控中心（风控业务逻辑需求）

        5. 日志中心（后台及核心操作日志跟踪）

        6. 配置中心（相关配置管理）

      ```
      3、游戏子系统（三方游戏接入及管理）
      4、支付子系统（三方支付、包含虚拟币支付接入及管理）
      5、推广子系统（外接推广渠道管理及推广域名管理）
      6、活动子系统（活动管理）
      ```

    - 服务：代理（pc和h5）emc后台 ems前端 定时任务第三方（两个）基础公共

    - 性能问题：当用户发布了一条微博后，微博发布子系统需要同步调用“统计子系统”“审核子系统”“奖励子系统”等共 8 个子系统，性能很低。

    - 耦合问题：当新增一个子系统时，那么广告子系统需要开发新的接口给新增的子系统调用。

    - 效率问题：每个子系统提供的接口参数和实现都有一些细微的差别，导致每次都需要重新设计接口和联调接口，开发团队和测试团队花费了许多重复工作量。

## 2. 需求分析

-
    + [5W 指 Who、When、What、Why、Where。Who：需求利益干系人，包括开发者、使用者、购买者、决策者等。When：需求使用时间，包括季节、时间、里程碑等。What：需求的产出是什么，包括系统、数据、文件、开发库、平台等。Where：需求的应用场景，包括国家、地点、环境等，例如测试平台只会在测试环境使用。Why：需求需要解决的问题，通常和需求背景相关]
        - Who：emc主要是业务子系统来使用，子系统发送消息或者接收消息。
        - When：当子系统需要发送异步通知的时候，需要使用emc。
        - What：需要开发emc。
        - Where：开发环境、测试环境、生产环境都需要部署。
        - Why：emc将子系统解耦，将同步调用改为异步通知。
    + 1H[How是关键业务流程。有的系统这部分内容很简单，但有的业务系统 1H 就是具体的用例文档”]
        - 性能：需要达到 Kafka 的性能水平。
        - 成本：参考 XX 设计方案，不超过 10 台服务器。
        - 时间：期望 3 个月内上线第一个版本，在两个业务尝试使用。
        - 可靠性：按照业务的要求，emc的可靠性需要达到 99.99%。
        - 安全性：emc仅在生产环境内网使用，无需考虑网络安全；如消息中有敏感信息，消息发送方需要自行进行加密，cocos图片加密混淆。
        - 合规性：emc需要按照目前的 DevOps 规范进行开发。
        - 技术性：目前团队主要研发人员是 Java，最好用 Java 开发。
        - 兼容性：之前有旧系统，需考虑兼容性。

## 3. 复杂度分析

- 确定了系统面临的主要复杂度问题后，方案设计就有了明确的目标，我们就可以开始真正进行架构方案设计了。
  ### 问题痛点
  二. 重难点问题复盘及重难点问题解决方案
  1、域名被墙解决方案
  2、DDOS与CC攻击应对方案
  3、高并发登陆应对方案
  4、高并发下注应对方案
  5、高并发充值提现应对方案
  6、报表查询缓慢应对方案
    - 玩家盈亏：查询五百万的数据，第一页十条，七秒。
    - mysql每天几次定时任务备份，每次备份产生70个G数据。单服务器并发两千
      7、接口响应缓慢应对方案
      8、断线重联、数据请求异常及程序异常前端交互体验流程方案
      9、前端数据缓存及后台数据变更通知刷新方案
      10、服务端数据缓存策略方案
      11、API接口支持分布式部署解决方案
      12、数据库分库策略及数据库表设计解决方案
      13、客户技术问题反馈收集方案
      14、新旧系统同步运营方案，旧数据ETL到新库解决方案
      15、10万级高并发读写设计、
      16、核心复杂业务需解耦

  ### 2. 高可用
    + cap 双机 集群 分区 异地多活
  ### 3. 高性能
    + 数据库集群：读写分离，分库分表，nosql，缓存
    + 服务器高性能模式：集群
    + 负载均衡：算法
  ### 4. 可扩展
    + 分层架构
  ### 5. 低成本，安全，规模

    + 低成本
        - 架构方案只涉及几台或者十几台服务器时，一般情况下成本并不是我们重点关注的目标
    + 安全（安全性要求）
        - 安全，从技术的角度来讲，安全可以分为两类：
            - 一类是功能上的安全
                - 功能安全例如，常见的 XSS攻击、CSRF 攻击、SQL
                  注入、Windows漏洞、密码破解等。框架只能预防常见的安全漏洞和风险（常见的XSS
                  攻击、CSRF 攻击、SQL 注入等），无法预知新的安全问题，而且框架本身很多时候也存在漏洞
            - 一类是架构上的安全。
    + 规模
        - 暂无

## 4. 设计备选方案

- 备选阶段关注的是技术选型，而不是技术细节，技术选型的差异要比较明显。


1. #### 总体方案

- [总体方案需要从整体上描述方案的结构，其核心内容就是架构图，以及针对架构图的描述，包括模块或者子系统的职责描述、核心流程]
  ![架构图](./img.png)

2. #### 架构总览

- [架构总览给出架构图以及架构的描述]
    - 架构关键设计点：采用数据分散集群的架构，集群中的服务器进行分组，每个分组存储一部分数据。每个分组包含一台主 MySQL
      和一台备MySQL，分组内主备数据复制，分组间数据不同步。正常情况下，分组内的主服务器对外提供消息写入和消息读取服务，备服务器不对外提供服务；主服务器宕机的情况下，备服务器对外提供消息读取的服务。客户端采取轮询的策略写入和读取消息。

3. #### 核心流程

- 充值到下单

4. #### 详细设计

- #### 高可用设计 
    - 数据库消息发送存储读取可靠性
- #### 高性能设计

> ### 1. 并发

- 缓存提升读写并发
    - 涉及金额，订单不存缓存。redis发布订阅通知游戏更新，通知不成功，定时任务。
    - 很容易出现，redis缓存不一致。玩家登陆，把库更新，redis没更新成功，机房，内网一般稳定。

> ### 1. io

### 1.mysqlio瓶颈提升

#### 硬件和操作系统层面优化：

- cpu 可用内存大小 网络带宽 磁盘读写速度。应用文件句炳数 操作系统的网络配置

##### 读写分离（主写从读）

##### 背景

- 读多写少，可以容忍不一致

##### 目的

- 提升读并发

##### 主从同步失败

- 强制读主 从库只有备份作用，没有分担读压力作用
- 主从同步复制，写操作性能降低
- GTID
- 去掉读写分离，改用缓存。缓存出现读写不一致现象

##### 优劣

- 主从主要是拓展性不强，一旦并发量大了，容易把mysql连接数打满
- 两千内并发。

##### 分库分表

- 一台物理机器部署一个库，连接分散到不同库，根据不同账号进不同库，分库分表。多个物理机，并发切库
- 不同机房通过cdn解决cc攻击。服务器配置：32核32g72线程

##### 背景

- 读多写少，可以容忍不一致

##### 目的

- 提升读并发

##### 主从同步失败

- 强制读主 从库只有备份作用，没有分担读压力作用
- 主从同步复制，写操作性能降低
- GTID
- 去掉读写分离，改用缓存。缓存出现读写不一致现象

##### 优劣

- 主从主要是拓展性不强，一旦并发量大了，容易把mysql连接数打满
- 两千内并发。

##### 分库分表

- 一台物理机器部署一个库，连接分散到不同库，根据不同账号进不同库，分库分表。多个物理机，并发切库
- 不同机房通过cdn解决cc攻击。服务器配置：32核32g72线程

##### mysql配置层面优化：

- binlog
- bufferpool大小配置
- 可扩展设计
- 安全设计
    + emc需要提供权限控制功能，权限控制包括两部分：身份识别和队列权限控制。身份识别emc给业务子系统分配身份标识和接入
      key，SDK 首先需要建立连接并进行身份校验，消息队列服务器会中断校验不通过的连接。因此，任何业务子系统如果想接入emc，都必须首先申请身份标识和接入
      key，通过这种方式来防止恶意系统任意接入。队列权限某些队列信息可能比较敏感，只允许部分子系统发送或者读取，emc将队列权限保存在配置文件中，当收到发送或者读取消息的请求时，首先需要根据业务子系统的身份标识以及配置的权限信息来判断业务子系统是否有权限，如果没有权限则拒绝服务。
    + emc需要接入已有的运维平台，通过运维平台发布和部署。emc需要输出日志给已有的监控平台，通过监控平台监控emc的健康状态，包括发送消息的数量、发送消息的大小、积压消息的数量等，详细监控指标在后续设计方案中列出。
    + 但如果业务对消息的可靠性、时序、事务性要求较高时，则要深入研究这些开源方案
- 部署方案
    + 部署方式：emc的服务器和数据库服务器采取混布的方式部署，即：一台服务器上，部署同一分组的主服务器和主 MySQL，或者备服务器和备
      MySQL。因为消息队列服务器主要是 CPU 密集型，而 MySQL 是磁盘密集型的，所以两者混布互相影响的几率不大。
    + 硬件的基本要求：32 核 48G 内存 512G SSD 硬盘，考虑到emc动态扩容的需求不高，且对性能要求较高，因此需要使用物理服务器，不采用虚拟机。
    + 组网方式。

## 5. 架构演进规划

- 整个emc分三期实现：
    + 第一期：实现--功能，预计时间 2 周。

### 技术方案选型对比

> ### 1. 存储层技术选型（数据库选型）

- 步骤：

1. 初步估计，参考业界类似开源系统的性能，评估系统性能上限，例如做消息队列可以参考RocketMQ；
2. 性能测试，等系统出来后做压测，测试系统真实性能；
3. 逐步调优，绝大部分系统不会一开始就做到最优，逐步优化才是现实途径
   现在要设计一个小文件存储系统，大概5亿+个小文件，其实学完还是不知道具体该怎么思考？怎么设计？怎么存储文件？怎么存放性能最佳？一台服务器存不下怎么水平扩展？查询时怎方便查找？怎么迅速的查找？文件之间是否存在结构关系？😀
   信息的存储，不管信息是以什么面相示人，核心在怎么存？怎么查？不同的信息有不同的结构，判断出合适的存储结构，这个很关键呀!
   下面就是，怎么再利用他方法加快存储的性能，如果单机容量到了瓶颈，以什么方式扩展才比较好？一般情况下都是用mysql，
   公司发展到一定阶段后，就会把这部分功能独立成中间件，比如百度的dbproxy，淘宝的tddl。
   中小公司一般使用开源方案，比如mysql推荐的mysql router，360开源的数据库中间件atlas。

| 数据库选型 | nosql | 关系型| 列数据库  | 内存数据库 |
|:------|:--------------|:-----|:------|:------|
| 分类    | redis,mongodb | mysql| hbase | redis |
| 应用场景  | Web应用(与Key-Value类似，Value是结构化的，不同的是数据库能够了解Value的内容)|  |   分布式的文件系统    | 内容缓存，主要用于处理大量数据的高访问负载，也用于一些日志系统等等     |
| 优点    | 数据结构要求不严格，表结构可变，不需要像关系型数据库一样需要预先定义表结构 | 存储结构化数据，事务性，join |查找速度快，可扩展性强，更容易进行分布式扩展    |查找速度快|
| 缺点    | 查询性能不高，而且缺乏统一的查询语法  |                  |功能相对局限| 数据无结构化，通常只被当作字符串或者二进制数|

#### 小文件存储

显示的数据，比如淘宝商品图片，商品描述，用户图片，微博内容等，这些数据有三个特点：1)
数据小，2）数量巨大，3）访问量巨大。小文件存储可以在公司业务起步阶段就可以统一考虑了。
一般地可以在开源方案（hbase,hadoop，hypertable，fasrdfs）的基础上封装一下就好了。
典型的小文件存储有淘宝的tfs，京东的jfs，facebook的haystack。

#### 大文件存储

海量的日志数据（各种访问日志，操作日志，用户轨迹日志等）。
_google的三篇大数据论文(bigtable/map-reduce/gfs)开启了一个大数据时代，而yahoo开源的hapdoop系列（hdfs，hbase等），_

#### 1. 背景目的

- 后台所有投注记录查询，单个代理/会员的投注记录查询，代理和框架
- 数据库要求；
    1. 高吞吐；
    1. 支持ACID事务；
    1. 大数据生态友好；
    1. 有水平扩张能力，并且尽量做到不侵入业务；

#### 2. 组件对比

| 组件选型    | 说明   | 数据存储         | 存储方式               | 适合场景                                                                                                                                                                                                      | 架构特点               | 优点                                                                                | 缺点                                                            | 事务                         | 数据一致性                  | join操作 |
|:---------|:------|:-------------|:-------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------|:-----------------------------------------------------------------------------------|:---------------------------------------------------------------|:----------------------------|:------------------------|:--------|
| mongodb | 非关系型 | 以类JSON存储，可扩展 | 虚拟内存+持久化硬盘，达到高速读写。 | 1.作为mysql:以类JSON存储，可扩展。(如日志博客之类)(3)mongodb本身的failover机制，无需使用如MHA之类的方式实现。 2.作为redis：sql语句与数据结构不如mysql那么亲和 ，也会有很多时候 将mongodb做为辅助mysql而使用的redis 之类的缓存db来使用。 亦或是仅作日志收集分析。                                     | 通过副本集，以及分片实现高可用    | 快速！在适量级的内存的Mongodb的性能是非常迅速的，它将热数据存储在物理内存中，使得热数据的读写变得十分快。</br>高扩展性，存储的数据格式是json格式！ | ① mongodb支持多文档事务操作。</br>mongodb占用空间过大。</br>开发文档不是很完全，完善。</br>（本身没有带事务机制，需要在MongoDB中实现事务机制，需要通过一个额外的表，从逻辑上自行实现事务） | MongoDB 4.0对多文档ACID事务的支持（1、多文档事务仅适用于副本集。注：如果是单机，需切到副本集模式。</br>2、仅适用于WiredTiger存储引擎。</br>3、如果你的架构是分片Sharding模式，事务是不支持的。分布式事务计划在4.2版本里支持。</br>4、事务只支持CRUD操作，DDL、DCL操作不支持。</br>注：CRUD就是MySQL的DML，意思一样叫法不同而已。</br>5、事务无法在config、admin和local系统数据库中读取或写入，无法在system.*(系统集合)里写入。</br>8、不能有大事务写入，写入集不能超过16MB(类似MariaDB Galera Cluster写入集wsrep_max_ws_size限制)，否则客户端直接报错。</br>注：如果有大事务，应该考虑将这些大事务拆分成若干块较小的事务。例如将大于2018年的状态值更改为1，应考虑循环1万条一批量更新，这一点跟MySQL玩法一样。 ） | 如果需要同步到其他组件，数据一致性和运维复杂 | 不支持    |
| mysql   | 关系型  |              |                    |                                                                                                                                                                                                           | acid               |  在不同的引擎上有不同 的存储方式。</br>查询语句是使用传统的sql语句，拥有较为成熟的体系，成熟度很高。 </br>                 | 在海量数据处理的时候效率会显著变慢。                                            | 支持 |                        | 支持     |

- ##### 1. mongodb

    - 不太适合放订单，金额。怎么保证事务，怎么聚合怎么查。 金额，账变，注单等避免分布式事务， 减少join操作，分多个库。

- ##### 2. mysql分库分表，数据聚合同步到es
    - 一台物理机器部署一个库，连接分散到不同库，根据不同账号进不同库，分库分表。多个物理机，并发切库。mysql
    - 只需要做数据聚合同步，避免分布式事务。

#### 3. 疑难风险：

1. 数据一致性

- mysql实现本地事务，减少分布式事务

分布式事务（ca/cp）

- mq实现弱一致性

### 3. 存储层方案对比

| 存储层方案选型           | 优点                  | 缺点                  |
|:------------------|:--------------------|---------------------|
| mysql读写分离+mongodb | 成本低， | 主从同步延迟造成数据不一致 ，mongodb不是严格acid    |
| mysql分库分表+es      | 分库分表分散连接            | 成本高和运维更复杂，数据同步的一致性等 |

> ### 2. 开发层和服务层和应用层技术选型

- 框架sprignboot+springcloud

#### 消息队列选型

![img_2.png](img_2.png)
- 综合以上情况，结合项目体量和后期规划，暂定rabbitmq
- #### 高可用设计
    - 消息发送可靠性
        + 业务服务器中嵌入emc提供的 SDK，SDK 支持轮询发送消息，当某个分组的主服务器无法发送消息时，SDK
          挑选下一个分组主服务器重发消息，依次尝试所有主服务器直到发送成功；如果全部主服务器都无法发送，SDK
          可以缓存消息，也可以直接丢弃消息，具体策略可以在启动 SDK 的时候通过配置指定。如果 SDK
          缓存了一些消息未发送，此时恰好业务服务器又重启，则所有缓存的消息将永久丢失，这种情况 SDK
          不做处理，业务方需要针对某些非常关键的消息自己实现永久存储的功能。
    - 消息存储可靠性
        + 消息存储在 MySQL 中，每个分组有一主一备两台 MySQL 服务器，MySQL 服务器之间复制消息以保证消息存储高可用。如果主备间出现复制延迟，恰好此时
          MySQL 主服务器宕机导致数据无法恢复，则部分消息会永久丢失，这种情况不做针对性设计，DBA 需要对主备间的复制延迟进行监控，当复制延迟超过
          30 秒的时候需要及时告警并进行处理。
    - 消息读取可靠性
        + 存储的高可用：主备方案、集群方案，
        + 高性能：负载均衡、多路复用。
        + 可扩展：分层、插件化等技术
- #### 高性能设计

> ### 3. 网络层和基础设施技术选型

- 步骤
    - 容量评估假设：

1. 首先，流量评估。
   1000万DAU，换算成秒级，平均约等于116。

考虑每个用户操作次数，假定10，换算成平均QPS=1160。

       考虑峰值是均值倍数，假定10，换算成峰值QPS=11600。
    
       考虑静态资源、图片资源、服务拆分等，流量放大效应，假定10，QPS*10=116000。 

2. 其次，容量规划。

       考虑高可用、异地多活，QPS*2=232000。
    
       考虑未来半年增长，QPS*1.5=348000。

3. 最后，方案设计。

       三级导流。
       
       第一级，DNS，确定机房，以目前量级，可以不考虑。
       
       第二级，确定集群，扩展优先，则选Haproxy/LVS，稳定优先则选F5。
       
       第三级，Nginx+KeepAlived，确定实例。

#### 1. 网络层和接入部署技术选型

- 机房配置：1. 同城多机房。2. 跨城多机房

#### 2. 运维架构容灾

- 多中心
- 异地多活

##### 3. 负载均衡

-
    1. dns
-
    2. Nginx 、LVS 、F5

##### 4. cdn

> ### 4. 大数据处理技术框架选型（对数据的及时性进型分类）
> ### 4. 用户层和业务层技术选型

- 无 后续划分业务和服务

## 5. 评估和选择备选方案

## 6. 详细方案设计

+ 结尾
    - mq削峰填谷或者db。
    - es物理库的订单查询。一两亿一两秒。
    - kafka把消息发到大数据。
    - 冷热备份，产品限制查两个月，分区表，一天一千万。
    - 每个游戏一个单独进程，每个游戏部署一台服务器或者多台服务器。一个游戏基本一个定时器，定时器很少是并行，多为串行。下注就不能发牌。比如处理客户端请求，回复客户端请求和定时任务不是同一个线程，不存在资源竞争不需要加锁。

